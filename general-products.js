window.CategoryProducts = {
  products: [
    {
      id: 801,
      name: 'HKS GTIII-RS Turbo Pro Kit with Cat Extension ',
      price: 1700,
      image: '71a.jpg',
      images: ['71b.jpg', '71c.jpg'],
      description: `HKS GTIII-RS Turbo Pro Kit with Cat Extension – For 2013+ BRZ, FR-S & 86

Unlock serious performance with the HKS GTIII-RS Turbo Pro Kit (Part No. 11001-AT005), engineered specifically for the 2013+ Subaru BRZ, Scion FR-S, and Toyota 86 platforms. This complete bolt-on turbo kit includes the high-efficiency GTIII-RS turbocharger and cat extension, making it the perfect solution for enthusiasts aiming for substantial horsepower gains with reliable, track-tested components.

Key Features:

Genuine HKS GTIII-RS Turbocharger for quick spool and high-output power

Direct-fit Pro Kit designed for FA20-powered BRZ/FR-S/86 (2013 and newer)

Includes cat extension for proper exhaust alignment

Brand new, never installed – ready for your next build

Ideal for serious power upgrades while maintaining daily drivability

Whether you're building a street machine or a dedicated track car, this turbo kit offers the performance, quality, and reliability HKS is known for`
    },
    {
      id: 802,
      name: 'Airlift V3 Complete Air Suspension Kit',
      price: 1750,
      image: '72a.jpg',
      images: ['72b.jpg', '72c.jpg'],
      description: `
Take your stance to the next level with this complete Airlift V3 Air Suspension Kit, designed for the Scion FR-S, Subaru BRZ, Toyota 86, and GR86 platforms. This kit was previously installed on a customer’s vehicle and removed after approximately 10,000 miles to return to a stock setup. It has since been fully cleaned, tested, and is ready for a new build.

This is a fully functional, used system including Airlift V3 3P management, dual compressors, and all major components required for a proper install. The front struts have received new pillow ball bearings, and although there is minor cosmetic rubbing on the front bags (pictured), the system has been leak-tested and confirmed to be in perfect working order.

Key Features:

Complete Airlift V3 3P air suspension system for BRZ, FR-S, 86 & GR86

Front and rear Airlift air struts included

Dual compressors for faster air-up times

4-gallon polished air tank + remote & full wiring harness

Front end links and auto-drain water trap included

Recently replaced pillow ball bearings (front)

Cleaned, tested, and ready to install

Extra airlines included for flexible routing options`
    },
    {
      id: 803,
      name: 'Nine Lives Racing “Big Wang” 69" Wing Kit – For FRS, BRZ & 86 (Gen 1 & Gen 2)',
      price: 710,
      image: '73a.jpg',
      images: ['73b.jpg', '73c.jpg'],
      description: `

Enhance downforce and track performance with the Nine Lives Racing 69" Big Wang Kit, built for both Gen 1 and Gen 2 Subaru BRZ, Scion FR-S, and Toyota 86 models. This package includes premium upgrades such as the MEGGA endplates, custom chassis mount, and a sleek Anthracite powder coat finish, giving you both function and form.

Designed for serious aero performance, this wing delivers proven results on and off the track. The included custom chassis mount provides increased rigidity but does require cutting slots in the trunk for proper installation. For those preferring a less invasive install, standard trunk mounts are available from Nine Lives Racing.

Key Features:

Genuine Nine Lives Racing 69" Big Wang Kit

Compatible with Gen 1 & Gen 2 BRZ / FR-S / 86

Includes MEGGA endplates ($192 upgrade) for added stability and style

Finished in Anthracite powder coat ($129 option)

Custom chassis mount for maximum strength (trunk modification required)

No gurney flap included (available separately)

Race-proven aero performance for serious drivers

Whether you're shaving seconds off lap times or dialing in your car’s look, this high-downforce wing setup gives you a competitive edge — with the premium upgrades already included`
    },
    {
      id: 804,
      name: 'Blitz Induction Kit',
      price: 320,
      image: '74a.jpg',
      images: ['74b.jpg', '74c.jpg'],
      description: `

Upgrade your engine’s breathing with the Blitz Induction Kit, designed to improve airflow and boost throttle response for a noticeable performance gain. This high-quality aftermarket air intake system is engineered for easy installation and enhanced engine efficiency, making it a popular choice among tuners and enthusiasts.

Key Features:

Improves airflow for better combustion and increased power

Precision-engineered for a direct-fit replacement of the factory intake

High-performance air filter designed for maximum filtration and flow

Durable construction built to withstand heat and harsh conditions

Easy to install with all necessary components included

Ideal for street and track use, the Blitz Induction Kit helps your engine breathe better, enhancing throttle response and overall driving experience`
    },
    {
      id: 805,
      name: 'RAYS Gramlights 57CR Wheels ',
      price: 2400,
      image: '75a.jpg',
      images: ['75b.jpg', '75c.jpg'],
      description: `

Upgrade your 5x100 platform with this mint condition set of RAYS Gramlights 57CR wheels in the popular Ceramic White Pearl finish. These iconic 5-spoke wheels are a top choice for street and occasional track use, prized for their lightweight strength, precise fitment, and timeless design.

Originally mounted on a customer’s car for just one month before switching setups, this set is practically like new. The wheels have been thoroughly deep-cleaned and ceramic-coated for long-lasting protection and an exceptional glossy shine. They come complete with original RAYS Japan boxes, decals, and documentation, making this set perfect for enthusiasts and collectors alike.

Key Specifications:

Wheel Size: 18x9.5 +38 (Squared setup)

Bolt Pattern: 5x100

Finish: Ceramic White Pearl

Tires: Brand new 225/40/18 — freshly mounted and never driven on

Condition Highlights:

No cracks, bends, or curb rash — true mint condition

Professionally deep cleaned and ceramic coated

Includes all original RAYS packaging and documentation

Known as RAYS’ most popular Gramlights design, the 57CR blends style, performance, and heritage — a must-have upgrade for your build.`
    },
    {
      id: 806,
      name: `OBX Stainless Steel Catback Exhaust – For 2013–2022 BRZ, 2013–2021 FR-S, 2012–2021 Toyota FT86 / GT86
`,
      price: 600,
      image: '76a.jpg',
      images: ['76b.jpg', '76c.jpg'],
      description: `
Enhance both the sound and performance of your 86-platform car with the OBX Stainless Steel Catback Exhaust, engineered for a perfect fit on the Subaru BRZ (2013–2022), Scion FR-S (2013–2021), and Toyota FT86/GT86 (2012–2021). Crafted from high-quality stainless steel, this exhaust system offers a clean, aggressive tone while improving exhaust flow and reducing backpressure.

Designed as a bolt-on upgrade, this catback exhaust delivers noticeable performance gains and a more engaging driving experience — all while maintaining daily drivability.

Key Features:

Direct-fit catback exhaust system for BRZ, FR-S, and GT86 platforms

Constructed from polished stainless steel for durability and corrosion resistance

Improved exhaust flow for increased power and throttle response

Aggressive, refined tone without excessive drone

Bolt-on installation using factory mounting points

Ideal for street builds, daily drivers, and spirited weekend use

Whether you're looking to improve performance or just want a more satisfying exhaust note, the OBX stainless catback offers a great balance of sound, looks, and value.`
    },
    {
      id: 807,
      name: 'Invidia N1 Catback Exhaust System – For Toyota 86 / Subaru BRZ / Scion FR-S',
      price: 580,
      image: '77a.jpg',
      images: ['77b.jpg', '77c.jpg'],
      description: `

Bring aggressive sound and track-inspired styling to your 86-platform build with the Invidia N1 Catback Exhaust System, designed for the Subaru BRZ, Scion FR-S, and Toyota 86. Known for its deep, refined tone and excellent build quality, the N1 catback is a favorite among enthusiasts looking to balance performance and aesthetics.

This system is in good condition, with no functional issues. It has been cleaned, sanded, and polished to restore its appearance, and it's ready for immediate installation.

Key Features:

Compatible with Subaru BRZ, Scion FR-S, and Toyota 86 (all model years)

Dual-exit Invidia N1 muffler design for an aggressive, race-inspired sound

High-quality stainless steel construction

Recently polished and restored — clean and ready to install

Includes brand new gasket and bolts for mounting

This is a well-maintained, performance-proven exhaust system ideal for drivers who want more character from their car without going over the top.`
    },
    {
      id: 808,
      name: `TRD x Bride Stradia II Semi-Bucket Seats – Premium Reclining Seats for Street & Track
`,
      price: 1200,
      image: '78a.jpg',
      images: ['78b.jpg', '78c.jpg'],
      description: `
Elevate your interior and driving experience with a rare set of TRD x Bride Stradia II semi-bucket seats. These premium reclining seats blend the aggressive styling and lateral support of a fixed-back bucket with the comfort and adjustability of a reclining seat — making them ideal for both spirited street driving and weekend track use.

Featuring TRD branding and Bride’s signature high-grip materials, this collaboration model delivers iconic JDM aesthetics with ergonomic support that enhances driver feedback and control.

Key Features:

Genuine TRD x Bride Stradia II semi-bucket seat pair

Reclining functionality for daily comfort with sport bucket support

High-side bolsters for secure seating under hard cornering

Premium materials with TRD branding — ideal for JDM builds

Suitable for both driver and passenger side setups

Lightweight design, compatible with standard aftermarket seat rails (rails not included)

A rare opportunity to own a highly sought-after set of seats that balance track-ready support with daily driving comfort — a must-have for TRD and JDM enthusiasts.`
    },
    {
      id: 809,
      name: `Skunk2 Racing 4-1 Equal Length Headers – For 2013–2020 BRZ / FR-S / 86`,
      price: 550,
      image: '79a.jpg',
      images: ['79b.jpg', '79c.jpg'],
      description: `

Maximize exhaust flow and power delivery with Skunk2 Racing’s 4-1 Equal Length (EL) Headers, designed for the 2013–2020 Subaru BRZ, Scion FR-S, and Toyota 86. Featuring a high-performance 4-1 design and merge collector, these headers are engineered for top-end horsepower gains and smooth throttle response — ideal for naturally aspirated builds or as part of a full exhaust upgrade.

This set has been professionally ceramic coated for improved heat resistance and durability and has never been installed since coating. The 2.5" outlet is ready to connect to most aftermarket overpipes or exhaust setups.

Key Features:

Equal length 4-1 header design for optimized power and efficiency

2.5" merge collector outlet for maximum flow

Professionally ceramic coated for reduced heat soak and enhanced durability

Direct fit for 2013–2020 BRZ / FR-S / 86

Never mounted after coating — like-new condition

A perfect upgrade for drivers seeking performance, sound, and reliability from a trusted brand in motorsports.`
    },
    {
      id: 810,
      name: 'Valenti REVO Jewel LED Tail Lights – Light Smoke / Black Chrome – For 2013–2020 BRZ, FR-S & 86',
      price: 450,
      image: '80a.jpg',
      images: ['80b.jpg', '80c.jpg'],
      description: `

Transform the rear-end look of your 86-platform with a set of Valenti REVO Jewel LED Tail Lights in the sought-after Light Smoke / Black Chrome finish. Known for their bold styling and premium construction, these taillights offer a sleek, high-end look while maintaining OEM+ appeal.

Featuring full LED operation, sequential turn signals, and distinctive LED light bars, the REVO series gives your car a head-turning signature both day and night. This set is lightly used, in excellent condition, and includes all mounting tabs — ready for plug-and-play installation.

Key Features:

Compatible with 2013–2020 BRZ / FR-S / Toyota 86

Light Smoke / Black Chrome housing for a modern, refined look

110 individual LEDs + dual LED light bars for brilliant illumination

Sequential or standard blinkers (switchable)

Built-in resistors — no hyperflash issues

Euro-style LED clear side markers

Plug-and-play installation – no modifications required

Fully DOT / SAE / E-mark compliant

Condition:

Lightly used – no cracks, chips, or damage

All mounting tabs intact

Fully functional – ready to install

One of the most desirable taillight upgrades available for the 86 platform — perfect for those looking to enhance both form and function.

`
    },
    {
      id: 811,
      name: 'Subaru BRZ|FRS|86 FA24 Engine',
      price: 4300,
      image: '1a.jpg',
      images: ['1b.jpg', '1c.jpg'],
      description: `2023 FA24 Engine with Headers & Carbon Covers – 14,992 Miles

This 2023 FA24 engine is in excellent condition with only 14,992 miles. It comes equipped with high-quality headers and carbon fiber engine covers, enhancing both performance and aesthetics.

Meticulously maintained and garage-kept, this engine has been serviced regularly and driven sparingly. A great opportunity for anyone looking to upgrade with a clean, low-mileage powertrain setup`
    },
    {
      id: 812,
      name: 'Set of front fenders compatible with Scion FRS|Toyota 86|Subaru BRZ',
      price: 450,
      image: '31a.jpg',
      images: ['31b.jpg', '31c.jpg'],
      description: `A clean set of front fenders compatible with Scion FR-S, Toyota 86, and Subaru BRZ. These fenders are in excellent condition with no cracks, dents, or structural damage—perfect for restoration projects or OEM replacements.

Ideal for anyone looking to maintain a factory look or replace worn or damaged panels with original-fit parts.`
    },
    {
      id: 813,
      name: '2013–2020 Scion FR-S / Toyota 86 / Subaru BRZ Alfa Style Fiberglass Front Bumper',
      price: 599,
      image: '37a.jpg',
      images: ['37b.jpg', '37c.jpg'],
      description: `Upgrade your ride with this Alfa Style fiberglass front bumper, designed to fit 2013–2020 models of the Scion FR-S, Toyota 86, and Subaru BRZ. Crafted from lightweight, durable fiberglass, this bumper offers an aggressive and sporty look while maintaining quality fitment.

Perfect for enthusiasts seeking a distinctive style upgrade that stands out on the road.`
    },
    {
      id: 814,
      name: 'VLAND Smoked Clear Sequential Taillights for FR-S, BRZ, and 86',
      price: 355,
      image: '53a.jpg',
      images: ['53b.jpg', '53c.jpg'],
      description: `Update the rear look of your FR-S, BRZ, or 86 with a brand-new set of VLAND Smoked Clear Sequential Taillights. These lights are still in their original box, only opened briefly for pictures, meaning they're absolutely pristine and ready for installation.

Once in place, you'll immediately notice the full LED upgrade, providing brighter and crisper illumination than stock. But the real showstopper? Those dynamic sequential turn signals that sweep across, giving your car a truly modern and high-end feel. Plus, the integrated boomerang daytime running light adds a sharp, distinctive signature whenever your lights are on. It's a complete visual transformation that brings contemporary style and enhanced visibility to your vehicle.`
    },
    {
      id: 815,
      name: 'OEM Reverse Light / Third Brake Light for Scion FR-S, Toyota 86, and Subaru BRZ',
      price: 170,
      image: '59a.jpg',
      images: ['59b.jpg', '59c.jpg'],
      description: `Acquire an authentic OEM reverse light, also functioning as the third brake light, for your sport compact. This unit originally came from a 2013 Scion FR-S, and it's fully compatible with all 2012 to 2016 Subaru BRZ and Toyota 86 models, ensuring a perfect fit and seamless integration. It's an ideal choice for anyone looking to replace a damaged unit or simply seeking a genuine, reliable component to maintain their vehicle's original integrity and safety features.`
    }
  ],
  productsPerPage: 5,
  currentPage: 1,
  renderProducts: function(page) {
    const grid = document.getElementById('categoryProducts');
    if (!grid) return;
    const start = (page - 1) * this.productsPerPage;
    const end = start + this.productsPerPage;
    const productsToShow = this.products.slice(start, end);
    grid.innerHTML = '';
    productsToShow.forEach((product, idx) => {
      const card = document.createElement('div');
      card.className = 'product-card';
      // Generate pretty URL slug
      function slugify(str) {
        return str.toString().toLowerCase().replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '').replace(/--+/g, '-');
      }
      const slug = slugify(product.name);
      // Remove .html from pathname for pretty URLs
      let basePath = window.location.pathname.replace(/\.html$/, '');
      if (basePath === '/' || basePath === '') basePath = '/general';
      const shareUrl = `${window.location.origin}${basePath}?product=${product.id}&slug=${slug}`;
      card.innerHTML = `
        <img src="${product.image}" alt="${product.name}" class="product-image">
        <div class="product-info">
          <h3 class="product-title">${product.name}</h3>
          <div class="product-price">$${product.price}</div>
          <button class="btn btn-small see-details-btn" data-id="${product.id}">See Details</button>
          <button class="btn btn-social copy-link-btn" data-link="${shareUrl}" style="margin:0.5em 0 0.5em 0;padding:0.3em 0.8em;font-size:0.98em;">
            <i class="fas fa-share-alt" style="margin-right:0.4em;"></i>Copy Link
          </button>
          <div class="product-card-controls">
            <button class="quantity-btn" data-action="dec">-</button>
            <input type="number" value="1" min="1" class="quantity-input" style="width:2.2em;">
            <button class="quantity-btn" data-action="inc">+</button>
            <button class="add-to-cart-btn" data-id="${product.id}">Add to Cart</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });
    // Add event listeners for quantity, add to cart, and copy link
    grid.querySelectorAll('.product-card').forEach((card, idx) => {
      const qtyInput = card.querySelector('.quantity-input');
      card.querySelector('[data-action="dec"]').onclick = () => {
        let v = parseInt(qtyInput.value) || 1;
        if (v > 1) qtyInput.value = v - 1;
      };
      card.querySelector('[data-action="inc"]').onclick = () => {
        let v = parseInt(qtyInput.value) || 1;
        qtyInput.value = v + 1;
      };
      card.querySelector('.add-to-cart-btn').onclick = () => {
        let v = parseInt(qtyInput.value) || 1;
        window.CategoryProducts.addToCart(productsToShow[idx], v);
      };
      // Copy link button
      const copyBtn = card.querySelector('.copy-link-btn');
      if (copyBtn) {
        copyBtn.onclick = function() {
          const link = copyBtn.getAttribute('data-link');
          navigator.clipboard.writeText(link).then(() => {
            copyBtn.textContent = 'Link Copied!';
            setTimeout(() => { copyBtn.innerHTML = `<i class=\"fas fa-share-alt\" style=\"margin-right:0.4em;\"></i>Copy Link`; }, 1400);
          });
        };
      }
    });
  },
  setupPagination: function() {
    const page1 = document.getElementById('page1');
    const page2 = document.getElementById('page2');
    const page3 = document.getElementById('page3');
    if (!page1 || !page2 || !page3) return;
    
    page1.onclick = () => {
      this.currentPage = 1;
      this.renderProducts(1);
      page1.classList.add('active');
      page2.classList.remove('active');
      page3.classList.remove('active');
    };
    page2.onclick = () => {
      this.currentPage = 2;
      this.renderProducts(2);
      page2.classList.add('active');
      page1.classList.remove('active');
      page3.classList.remove('active');
    };
    page3.onclick = () => {
      this.currentPage = 3;
      this.renderProducts(3);
      page3.classList.add('active');
      page1.classList.remove('active');
      page2.classList.remove('active');
    };
  },
  setupDetailsModal: function() {
    const grid = document.getElementById('categoryProducts');
    const closeBtn = document.getElementById('closeDetailBtn');
    const backBtn = document.getElementById('backToCatalogBtn');
    if (!grid || !closeBtn || !backBtn) return;
    grid.onclick = function(e) {
      if (e.target.classList.contains('see-details-btn')) {
        const productId = parseInt(e.target.getAttribute('data-id'));
        this.showProductDetail(productId);
      }
    }.bind(this);
    closeBtn.onclick = this.hideProductDetail;
    backBtn.onclick = this.hideProductDetail;
  },
  addToCart: function(product, qty) {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const existing = cart.find(item => item.id === product.id);
    if (existing) {
      existing.qty = Number(existing.qty || 0) + Number(qty || 1);
    } else {
      cart.push({ id: product.id, title: product.name, price: product.price, qty: Number(qty || 1), image: product.image });
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    // Update cart count in header if present
    let totalCount = cart.reduce((sum, item) => Number(sum) + Number(item.qty || 0), 0);
    let cartCount = document.querySelector('.cart-count');
    if (cartCount) cartCount.textContent = totalCount;
    // Confirmation message
    let conf = document.getElementById('cartConfirmMsg');
    if (!conf) {
      conf = document.createElement('div');
      conf.id = 'cartConfirmMsg';
      conf.style.position = 'fixed';
      conf.style.top = '24px';
      conf.style.left = '50%';
      conf.style.transform = 'translateX(-50%)';
      conf.style.background = '#fff';
      conf.style.color = '#222';
      conf.style.border = '1.5px solid #b80000';
      conf.style.borderRadius = '8px';
      conf.style.boxShadow = '0 4px 24px rgba(0,0,0,0.13)';
      conf.style.padding = '1.1em 2.2em';
      conf.style.fontSize = '1.08rem';
      conf.style.fontWeight = '600';
      conf.style.zIndex = '10000';
      conf.style.display = 'none';
      document.body.appendChild(conf);
    }
    conf.innerHTML = `<i class="fas fa-check-circle" style="color:#b80000;margin-right:0.6em;"></i> ${qty} × <b>${product.name}</b> added to cart!`;
    conf.style.display = 'block';
    setTimeout(() => { conf.style.display = 'none'; }, 2200);
  },
  showProductDetail: function(productId) {
    const product = this.products.find(p => p.id === productId);
    if (!product) return;
    const modal = document.getElementById('productDetailModal');
    if (!modal) return;
    // Generate pretty URL slug
    function slugify(str) {
      return str.toString().toLowerCase().replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '').replace(/--+/g, '-');
    }
    const slug = slugify(product.name);
    // Remove .html from pathname for pretty URLs
    let basePath = window.location.pathname.replace(/\.html$/, '');
    if (basePath === '/' || basePath === '') basePath = '/general';
    const shareUrl = `${window.location.origin}${basePath}?product=${product.id}&slug=${slug}`;
    modal.innerHTML = `
      <div class="product-detail-content">
          <button class="close-detail" onclick="window.CategoryProducts.hideProductDetail()">&times;</button>
          <div class="product-detail-header">
              <h2>${product.name}</h2>
          </div>
          <div class="product-detail-body">
              <div class="product-images" id="modalProductImgs">
                  ${product.images.map(img => `<img src="${img}" alt="${product.name}" class="modal-img-thumb" style="width:160px;height:110px;object-fit:contain;margin:0.5em;cursor:pointer;border-radius:8px;background:#f7f7f7;border:1px solid #eee;">`).join("")}
              </div>
              <div class="product-info">
                  <div class="product-price">$${product.price.toFixed(2)}</div>
                  <div class="product-description">${product.description}</div>
                  <button class="btn btn-social copy-link-btn-modal" data-link="${shareUrl}" style="margin:0.7em 0 1.1em 0;padding:0.3em 0.8em;font-size:1em;width:100%;"><i class="fas fa-share-alt" style="margin-right:0.4em;"></i>Copy Link to This Product</button>
                  <div class="quantity-controls" style="display:flex;align-items:center;gap:0.7rem;margin-bottom:1.2rem;">
                      <button class="quantity-btn" id="qtyDecModal">-</button>
                      <input type="number" value="1" min="1" class="quantity-input" id="qtyValModal" style="width:2.2em;">
                      <button class="quantity-btn" id="qtyIncModal">+</button>
                  </div>
                  <button class="add-to-cart-btn" id="modalAddToCartBtn" style="width:100%;margin-bottom:0.7rem;">Add to Cart</button>
                  <button class="btn btn-secondary" onclick="window.CategoryProducts.hideProductDetail()">Back to Catalog</button>
              </div>
          </div>
      </div>
    `;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    // Modal quantity logic
    const qtyInput = modal.querySelector('#qtyValModal');
    modal.querySelector('#qtyDecModal').onclick = () => {
      let v = parseInt(qtyInput.value) || 1;
      if (v > 1) qtyInput.value = v - 1;
    };
    modal.querySelector('#qtyIncModal').onclick = () => {
      let v = parseInt(qtyInput.value) || 1;
      qtyInput.value = v + 1;
    };
    modal.querySelector('#modalAddToCartBtn').onclick = () => {
      let v = parseInt(qtyInput.value) || 1;
      window.CategoryProducts.addToCart(product, v);
    };
    // Copy link in modal
    const copyBtnModal = modal.querySelector('.copy-link-btn-modal');
    if (copyBtnModal) {
      copyBtnModal.onclick = function() {
        const link = copyBtnModal.getAttribute('data-link');
        navigator.clipboard.writeText(link).then(() => {
          copyBtnModal.textContent = 'Link Copied!';
          setTimeout(() => { copyBtnModal.innerHTML = `<i class=\"fas fa-share-alt\" style=\"margin-right:0.4em;\"></i>Copy Link to This Product`; }, 1400);
        });
      };
    }
    // Lightbox logic
    modal.querySelectorAll('.modal-img-thumb').forEach(img => {
      img.onclick = function() {
        const lightbox = document.createElement('div');
        lightbox.className = 'lightbox-modal';
        lightbox.innerHTML = `<button class='close-lightbox'>&times;</button><img src='${img.src}' style='max-width:90vw;max-height:85vh;'>`;
        document.body.appendChild(lightbox);
        lightbox.querySelector('.close-lightbox').onclick = () => lightbox.remove();
        lightbox.onclick = (e) => { if (e.target === lightbox) lightbox.remove(); };
      };
    });
  },
  hideProductDetail: function() {
    const modal = document.getElementById('productDetailModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  }
};

document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('categoryProducts')) {
    // Check for ?product=ID or pretty URL slug
    const urlParams = new URLSearchParams(window.location.search);
    let productIdParam = urlParams.get('product');
    let slugParam = urlParams.get('slug');
    let initialPage = 1;
    let openProductId = null;
    if (productIdParam) {
      // If slug is present, verify it matches, else fallback to ID
      const idx = window.CategoryProducts.products.findIndex(p => String(p.id) === String(productIdParam));
      if (idx !== -1) {
        initialPage = Math.floor(idx / window.CategoryProducts.productsPerPage) + 1;
        openProductId = window.CategoryProducts.products[idx].id;
      }
    } else if (slugParam) {
      // If only slug is present, find by slug
      function slugify(str) {
        return str.toString().toLowerCase().replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '').replace(/--+/g, '-');
      }
      const idx = window.CategoryProducts.products.findIndex(p => slugify(p.name) === slugParam);
      if (idx !== -1) {
        initialPage = Math.floor(idx / window.CategoryProducts.productsPerPage) + 1;
        openProductId = window.CategoryProducts.products[idx].id;
      }
    }
    window.CategoryProducts.renderProducts(initialPage);
    window.CategoryProducts.setupPagination();
    window.CategoryProducts.setupDetailsModal();
    // Set active page button
    const pageBtn = document.getElementById('page' + initialPage);
    if (pageBtn) pageBtn.classList.add('active');
    // After rendering, scroll to product if needed
    if (openProductId) {
      setTimeout(() => {
        const card = Array.from(document.querySelectorAll('.product-card')).find(card => {
          const seeBtn = card.querySelector('.see-details-btn');
          return seeBtn && String(seeBtn.getAttribute('data-id')) === String(openProductId);
        });
        if (card) {
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          card.classList.add('highlight-product');
          setTimeout(() => card.classList.remove('highlight-product'), 2200);
        }
        // Auto-open modal for pretty URL
        window.CategoryProducts.showProductDetail(openProductId);
      }, 200);
    }
  }
  // Add highlight style for auto-scroll
  const style = document.createElement('style');
  style.innerHTML = `.highlight-product { box-shadow: 0 0 0 4px #b8000099, 0 4px 24px rgba(0,0,0,0.13); transition: box-shadow 0.3s; }`;
  document.head.appendChild(style);
});